# Creates a pre-release for any dev branch commits

name: Build Development Pre-Release

on:
  push:
    branches: [ dev ]

jobs:
  build-release:
    name: Build Development Pre-Release
    runs-on: ubuntu-latest

    permissions:
      contents: write   # Needed for deleting/creating releases & tags

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set tag name
        id: vars
        run: echo "TAG=v.${GITHUB_REF_NAME}" >> $GITHUB_ENV

      # -----------------------------
      # Delete existing release & tag
      # -----------------------------
      - name: Delete existing release (if any)
        run: |
          gh release delete "$TAG" --yes || echo "No existing release"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete existing tag (if any)
        run: |
          git tag -d "$TAG" 2>/dev/null || true
          gh api --method DELETE "repos/${GITHUB_REPOSITORY}/git/refs/tags/$TAG" || echo "No existing tag"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------
      # Create new prerelease
      # -----------------------------
      - name: Create development prerelease
        run: |
          gh release create "$TAG" \
            --target dev \
            --title "Development Build (Unpackaged)" \
            --prerelease \
            --draft=false
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
